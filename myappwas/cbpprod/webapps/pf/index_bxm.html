<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Product Factory</title>

    <link href="libs/pfui/dpl.css" rel="stylesheet">
    <link href="libs/pfui/pfui.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/font-awesome/css/font-awesome.min.css">
    <link href="/pf_common/style/css/bx-login-style.css" rel="stylesheet">
</head>

<body class="fc-bg fc-body">

<section id="bx-login-wrap">
    <section class="bx-login-layer">
        <section class="bx-login-layer-body">
            <h1 class="title">Product Factory</h1>

            <table class="login-form-table">
                <tr>
                    <td colspan="2">
                        Select language
                        <select class="language-select-box">
                            <option value="ko">Korean</option>
                            <option value="ja">Japanese</option>
                            <option value="cn">Chinese</option>
                            <option value="en">English</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>Institution</label>
                        <!--<input type="text" placeholder="Institution Name" class="institution-name">-->
                        <select class="institution-name">
                        	<!-- 
                                <option value="103">K뱅크</option>
                                <option value="000">Admin</option>
                                <option value="998">데모은행</option>
                                <option value="999">표준은행</option>
                                <option value="401">국민카드(kbcard)</option>
                                <option value="402">비씨카드(bccard)</option>
                                <option value="403">NH농협카드(nhcard)</option>
                                <option>-------------------------------</option>
                                <option value="205">Myanmar JL Group</option>
                                <option value="206">다이렉트뱅킹</option>
                                <option value="207">FIN MALL</option>
                                <option value="301">Trust Bank</option>
                                <option value="302">City Bank</option>
                                <option value="STDA">Standard Bank</option>
                                <option value="STDA1605">STDA1605</option>
                                <option value="001">서울은행</option>
                                <option value="002">경기은행</option>
                                <option value="101">부산은행</option>
                                <option value="102">제주은행</option>
                                <option value="201">Tailong Bank</option>
                                <option value="203">P2P전문은행</option>
                                <option value="204">SCF전문은행</option>
                                <option value="POSTMAN">포스트맨테스트</option>
                           -->
                        </select>
                        <!--<button class="institution-search-btn"></button> -->
                    </td>
                </tr>
                <tr>
                    <td class="bx-login-field" colspan="2">
                        <input type="text" class="bx-form-item user-id" name="id" placeholder="ID">
                    </td>
                </tr>
                <tr>
                    <td class="bx-login-field" colspan="2">
                        <input type="password" class="bx-form-item" name="pwd" placeholder="Password">
                    </td>
                </tr>
                <tr>
                    <td class="bx-login-field bx-operator-filed" colspan="2">
                        <label for="remember-id-check" class="remember-id-label">
                            <input id="remember-id-check" class="bx-form-item" type="checkbox">
                            Remember ID
                        </label>
                        <button type="submit" class="bx-btn bx-btn-primary" id="bx-login-btn">Login</button>
                    </td>
                </tr>
            </table>
        </section>
        <section class="copyright">
            2018 © BankwareGlobal
        </section>
    </section>
</section>

<script src="libs/jquery/jquery.js"></script>
<script>

    $('input[name=id]').focus();
    rememberIdCheck();
    loadTntInstId();

    $('body').on('keydown', function(e) {
        if(e.keyCode === 13)  {
            login();
        }
    });

    $('#bx-login-btn').on('click', login);

    // 02. bxm
    function login() {

        var param = {
            commonHeader: {loginTntInstId: $('.institution-name').val()}
            , staffId: $('[name=id]').val()
            , passwd: $('[name=pwd]').val()
        };
        var bxmParam = {
            header : {
                application : 'PF_Factory',
                service : 'LoginProcessService',
                operation : 'loginProcess',
                locale: $('.language-select-box').val()
            },
            input : param
        };

        $.ajax({
            type: 'post',
            url: '/serviceEndpoint/json/request.json',//'login.json',
            headers: {
                'Accept-Language': $('.language-select-box').val()
            },
            cache: false,
            data: JSON.stringify(bxmParam),
            contentType: 'application/json; charset=UTF-8',
            success: function(responseData) {
                var response = (typeof responseData === 'string') ? JSON.parse(responseData) : responseData;
                if(response.responseMessage || (response.ModelMap && response.ModelMap.responseMessage)) {

                    var data = response.ModelMap.responseMessage;

                    setCookie('lang'            , $('.language-select-box').val(), 1);
                    setCookie('mother'          , data.mother                    , 1);
                    setCookie('motherTntInstId' , data.motherTntInstId           , 1);
                    setCookie('tntInstId'       , data.tntInstId                 , 1);
                    setCookie('tntInstName'     ,  $('.institution-name option:selected').text() , 1);
                    setCookie('loginId'         , data.staffId                   , 1);
                    setCookie('loginNm'         , data.staffNm                   , 1);


                    location.pathname = '/main.html';
                }else if(responseData.header && responseData.header.messageCode && responseData.header.messageCode != '') {
                    var errorMessage = "";
                    responseData.header.messages.forEach(function (errorMsg) {
                        // Error Message 정비. 메세지만 출력
                        //errorMessage += '<p>['+error.errorCode + '] '+error.errorMsg+'</p>';
                        errorMessage += errorMsg;
                    });

                    if(errorMessage.length > 0 ){
                        alert(errorMessage);
                    }else{
                        alert('로그인 정보가 틀립니다.');
                    }
                }else {
                    alert('로그인 정보가 틀립니다.');
                }

            }
        });
    }
    
 // 02. bxm
	function loadTntInstId() {
		var param = {
			commonHeader: {loginTntInstId : $('.institution-name').val()},
			tntInstId: 'TNT_INST_ALL_QUERY',
		};
		var bxmParam = {
			header : {
				application : 'PF_Factory',
				service : 'TenantInstitutionService',
				operation : 'getListTenantInstitution'
			},
			input : param
		};

		$.ajax({
            type: 'post',
            url: '/serviceEndpoint/json/request.json',
            headers: {
                'Accept-Language': $('.language-select-box').val()
            },
			cache: false,
			data: JSON.stringify(bxmParam),
			contentType: 'application/json; charset=UTF-8',
			success: function(responseData) {
				var response = (typeof responseData === 'string') ? JSON.parse(responseData) : responseData;
				if(response.responseMessage || response.ModelMap.responseMessage) {

					var data = response.ModelMap.responseMessage;

					let select = $('.institution-name');
					let options = [];
					console.log(select, options, response);
					if (data) {
						data.forEach(v => {
							let $option = $("<option>");
							$option.val(v.tntInstId);
							$option.text(v.tntInstNm);
	        				options.push($option);
						});
						select.html(options);
					}
				}
			}
		});
	}

    $('#remember-id-check').on('change', function(e){
        if($(e.currentTarget).prop('checked')){
            setCookie('rememberUserId', $('.bx-login-field .user-id').val(),10);
        }
    })

    function rememberIdCheck(){
        if(getCookie('rememberUserId')){
            $('.bx-login-field .user-id').val(getCookie('rememberUserId'));
            $('#remember-id-check').prop('checked', true);
        }

    }

    function setCookie(cName, cValue, cDate){
        var expire = new Date();
        expire.setDate(expire.getDate()+cDate);
        var cookies = cName + '=' + escape(cValue) + '; path=/ ';
        if(typeof cMinute != 'undefined') cookies += ';expires=' + expire.toGMTString() + ';';
        document.cookie = cookies;
    }

    function getCookie(cName) {
        cName = cName + '=';
        var cookieData = document.cookie;
        var start = cookieData.indexOf(cName);
        var cValue = '';
        if(start != -1){
            start += cName.length;
            var end = cookieData.indexOf(';', start);
            if(end == -1)end = cookieData.length;
            cValue = cookieData.substring(start, end);
        }
        return unescape(cValue);
    }

</script>

</body>
</html>